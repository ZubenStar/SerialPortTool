<Window
    x:Class="SerialPortTool.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:converters="using:SerialPortTool.Converters"
    mc:Ignorable="d"
    Title="{x:Bind ViewModel.Title, Mode=OneWay}">

    <Grid>
        <Grid.Resources>
            <converters:HexColorToBrushConverter x:Key="HexColorToBrushConverter"/>
        </Grid.Resources>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Menu Bar -->
        <MenuBar Grid.Row="0">
            <MenuBarItem Title="æ–‡ä»¶">
                <MenuFlyoutItem Text="é€€å‡º" Click="Exit_Click"/>
            </MenuBarItem>
            <MenuBarItem Title="å·¥å…·">
                <MenuFlyoutItem Text="æ‰«æä¸²å£" Command="{x:Bind ViewModel.ScanPortsCommand}"/>
                <MenuFlyoutSeparator/>
                <MenuFlyoutItem Text="æ‰“å¼€æ—¥å¿—æ–‡ä»¶å¤¹" Click="OpenLogFolder_Click"/>
            </MenuBarItem>
            <MenuBarItem Title="å¸®åŠ©">
                <MenuFlyoutItem Text="å…³äºŽ" Click="About_Click"/>
            </MenuBarItem>
        </MenuBar>

        <!-- Main Content -->
        <Grid Grid.Row="1" Padding="8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Sidebar -->
            <Grid Grid.Column="0" Padding="0,0,8,0">
                <StackPanel Spacing="16">
                    <!-- Port Configuration -->
                    <StackPanel Spacing="8">
                        <TextBlock Text="ä¸²å£é…ç½®"
                                   Style="{StaticResource SubtitleTextBlockStyle}"
                                   FontWeight="SemiBold"/>
                        
                        <StackPanel Spacing="4">
                            <TextBlock Text="æ³¢ç‰¹çŽ‡:" FontSize="12"/>
                            <ComboBox x:Name="BaudRateComboBox"
                                      ItemsSource="{x:Bind ViewModel.AvailableBaudRates}"
                                      SelectedItem="{x:Bind ViewModel.BaudRate, Mode=TwoWay}"
                                      HorizontalAlignment="Stretch"/>
                        </StackPanel>
                        
                        <StackPanel Spacing="4">
                            <CheckBox Content="è‡ªå®šä¹‰æ³¢ç‰¹çŽ‡"
                                      IsChecked="{x:Bind ViewModel.UseCustomBaudRate, Mode=TwoWay}"
                                      FontSize="12"
                                      Checked="CustomBaudRateCheckBox_Changed"
                                      Unchecked="CustomBaudRateCheckBox_Changed"/>
                            <TextBox x:Name="CustomBaudRateTextBox"
                                     PlaceholderText="è¾“å…¥è‡ªå®šä¹‰æ³¢ç‰¹çŽ‡..."
                                     Text="{x:Bind ViewModel.CustomBaudRate, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                     HorizontalAlignment="Stretch"
                                     InputScope="Number"
                                     Visibility="Collapsed"/>
                        </StackPanel>
                        
                        <StackPanel Spacing="4">
                            <TextBlock Text="æ•°æ®ä½:" FontSize="12"/>
                            <ComboBox ItemsSource="{x:Bind ViewModel.AvailableDataBits}"
                                      SelectedItem="{x:Bind ViewModel.DataBits, Mode=TwoWay}"
                                      HorizontalAlignment="Stretch"/>
                        </StackPanel>
                    </StackPanel>

                    <!-- Available Ports -->
                    <StackPanel Spacing="8">
                        <TextBlock Text="å¯ç”¨ä¸²å£"
                                   Style="{StaticResource SubtitleTextBlockStyle}"
                                   FontWeight="SemiBold"/>
                        
                        <Button Content="ðŸ”„ æ‰«æä¸²å£"
                                Command="{x:Bind ViewModel.ScanPortsCommand}"
                                HorizontalAlignment="Stretch"/>
                        
                        <Button Content="ðŸ“‚ æ‰“å¼€æ‰€æœ‰ä¸²å£"
                                Command="{x:Bind ViewModel.OpenAllPortsCommand}"
                                HorizontalAlignment="Stretch"
                                Background="{ThemeResource AccentFillColorDefaultBrush}"/>
                        
                        <ListView x:Name="PortListView"
                                  ItemsSource="{x:Bind ViewModel.AvailablePorts, Mode=OneWay}"
                                  SelectionMode="Single"
                                  MaxHeight="300"
                                  SelectionChanged="PortListView_SelectionChanged">
                            <ListView.ItemTemplate>
                                <DataTemplate x:DataType="x:String">
                                    <Grid>
                                        <TextBlock Text="{x:Bind}" VerticalAlignment="Center"/>
                                    </Grid>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </StackPanel>

                    <!-- Open Ports -->
                    <StackPanel Spacing="8">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <TextBlock Grid.Column="0"
                                       Text="å·²æ‰“å¼€ä¸²å£"
                                       Style="{StaticResource SubtitleTextBlockStyle}"
                                       FontWeight="SemiBold"
                                       VerticalAlignment="Center"/>
                            
                            <Button Grid.Column="1"
                                    Content="âŒ"
                                    ToolTipService.ToolTip="å…³é—­æ‰€æœ‰ä¸²å£"
                                    Command="{x:Bind ViewModel.CloseAllPortsCommand}"
                                    FontSize="14"
                                    Padding="8,4"/>
                        </Grid>
                        
                        <ListView x:Name="OpenPortListView"
                                  ItemsSource="{x:Bind ViewModel.OpenPorts, Mode=OneWay}"
                                  SelectionMode="Single"
                                  Height="200">
                            <ListView.ItemTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- é¢œè‰²æŒ‡ç¤ºå™¨å’Œé€‰æ‹©å™¨ -->
                                        <ComboBox Grid.Column="0"
                                                  SelectedValue="{Binding ColorHex, Mode=TwoWay}"
                                                  SelectedValuePath="Tag"
                                                  Width="50"
                                                  Margin="0,0,8,0"
                                                  VerticalAlignment="Center"
                                                  ToolTipService.ToolTip="é€‰æ‹©ç«¯å£é¢œè‰²">
                                            <ComboBoxItem Tag="#107C10"><Rectangle Width="16" Height="16" Fill="#107C10"/></ComboBoxItem>
                                            <ComboBoxItem Tag="#0078D4"><Rectangle Width="16" Height="16" Fill="#0078D4"/></ComboBoxItem>
                                            <ComboBoxItem Tag="#E74856"><Rectangle Width="16" Height="16" Fill="#E74856"/></ComboBoxItem>
                                            <ComboBoxItem Tag="#FF8C00"><Rectangle Width="16" Height="16" Fill="#FF8C00"/></ComboBoxItem>
                                            <ComboBoxItem Tag="#881798"><Rectangle Width="16" Height="16" Fill="#881798"/></ComboBoxItem>
                                            <ComboBoxItem Tag="#00B7C3"><Rectangle Width="16" Height="16" Fill="#00B7C3"/></ComboBoxItem>
                                            <ComboBoxItem Tag="#C239B3"><Rectangle Width="16" Height="16" Fill="#C239B3"/></ComboBoxItem>
                                            <ComboBoxItem Tag="#498205"><Rectangle Width="16" Height="16" Fill="#498205"/></ComboBoxItem>
                                            <ComboBoxItem Tag="#8764B8"><Rectangle Width="16" Height="16" Fill="#8764B8"/></ComboBoxItem>
                                            <ComboBoxItem Tag="#CA5010"><Rectangle Width="16" Height="16" Fill="#CA5010"/></ComboBoxItem>
                                        </ComboBox>

                                        <StackPanel Grid.Column="1" Spacing="4">
                                            <TextBlock Text="{Binding PortName}"
                                                       FontWeight="SemiBold"/>
                                            <TextBlock Text="{Binding StatisticsDisplay, Mode=OneWay}"
                                                       FontSize="12"
                                                       Opacity="0.7"/>
                                        </StackPanel>

                                        <Button Grid.Column="2"
                                                Content="âŒ"
                                                FontSize="12"
                                                Padding="4"
                                                VerticalAlignment="Center"
                                                Click="ClosePort_Click"
                                                Tag="{Binding PortName}"/>
                                    </Grid>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </StackPanel>
                </StackPanel>
            </Grid>

            <!-- Main Content Area -->
            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Baud Rate Detection Alert -->
                <Border x:Name="BaudRateAlertBorder"
                        Grid.Row="0"
                        Background="#FFF3CD"
                        BorderBrush="#FFEEA4"
                        BorderThickness="1"
                        CornerRadius="4"
                        Padding="12,8"
                        Margin="8,8,8,4"
                        Visibility="Collapsed">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <TextBlock Grid.Column="0"
                                   Text="âš ï¸"
                                   FontSize="16"
                                   VerticalAlignment="Center"
                                   Margin="0,0,8,0"/>
                        
                        <StackPanel Grid.Column="1" Spacing="4">
                            <TextBlock x:Name="BaudRateAlertTitle"
                                       Text="æ£€æµ‹åˆ°æ³¢ç‰¹çŽ‡å¯èƒ½ä¸åŒ¹é…"
                                       FontWeight="SemiBold"
                                       FontSize="14"/>
                            <TextBlock x:Name="BaudRateAlertMessage"
                                       Text="å»ºè®®åˆ‡æ¢åˆ°æ­£ç¡®çš„æ³¢ç‰¹çŽ‡ä»¥èŽ·å¾—æ›´å¥½çš„æ•°æ®è´¨é‡"
                                       FontSize="12"
                                       Opacity="0.8"
                                       TextWrapping="Wrap"/>
                        </StackPanel>
                        
                        <StackPanel Grid.Column="2"
                                    Orientation="Horizontal"
                                    Spacing="8"
                                    VerticalAlignment="Center">
                            <Button x:Name="AutoFixBaudRateButton"
                                    Content="è‡ªåŠ¨ä¿®å¤"
                                    Style="{StaticResource AccentButtonStyle}"
                                    Click="AutoFixBaudRate_Click"
                                    FontSize="12"/>
                            <Button x:Name="DismissAlertButton"
                                    Content="å¿½ç•¥"
                                    Click="DismissAlert_Click"
                                    FontSize="12"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Search and Controls -->
                <StackPanel Grid.Row="0" Padding="8" Spacing="8" Margin="8,4,8,8">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <StackPanel Spacing="4">
                            <Grid Width="350">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <ComboBox x:Name="SearchBox"
                                         Grid.Column="0"
                                         PlaceholderText="æ­£åˆ™è¡¨è¾¾å¼æœç´¢..."
                                         IsEditable="True"
                                         Text="{x:Bind ViewModel.SearchText, Mode=TwoWay}"
                                         ItemsSource="{x:Bind ViewModel.RecentSearchTexts, Mode=OneWay}"
                                         SelectionChanged="SearchBox_SelectionChanged"
                                         DropDownClosed="SearchBox_DropDownClosed"
                                         LostFocus="SearchBox_LostFocus"
                                         KeyDown="SearchBox_KeyDown"
                                         HorizontalAlignment="Stretch"
                                         MaxDropDownHeight="200">
                                    <ComboBox.ItemContainerStyle>
                                        <Style TargetType="ComboBoxItem">
                                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                            <Setter Property="MinWidth" Value="320"/>
                                        </Style>
                                    </ComboBox.ItemContainerStyle>
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate x:DataType="x:String">
                                            <Grid Margin="0,4" HorizontalAlignment="Stretch">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Grid.Column="0"
                                                          Text="{x:Bind}"
                                                          VerticalAlignment="Center"
                                                          Margin="0,0,8,0"
                                                          TextWrapping="NoWrap"
                                                          TextTrimming="CharacterEllipsis"
                                                          ToolTipService.ToolTip="{x:Bind}"/>

                                                <Button Grid.Column="1"
                                                       Content="ðŸ—‘ï¸"
                                                       FontSize="12"
                                                       Padding="6,4"
                                                       MinWidth="28"
                                                       VerticalAlignment="Center"
                                                       Click="DeleteSearchHistory_Click"
                                                       Tag="{x:Bind}"
                                                       ToolTipService.ToolTip="åˆ é™¤æ­¤åŽ†å²è®°å½•"/>
                                            </Grid>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>

                                <Button Grid.Column="1"
                                       x:Name="ClearSearchTextButton"
                                       Content="âœ•"
                                       ToolTipService.ToolTip="æ¸…ç©ºå½“å‰æœç´¢"
                                       Click="ClearSearchText_Click"
                                       Padding="8,4"
                                       Margin="4,0,0,0"
                                       VerticalAlignment="Center">
                                    <Button.Visibility>
                                        <Binding Path="ViewModel.HasSearchText" Mode="OneWay">
                                            <Binding.Converter>
                                                <StaticResource ResourceKey="BoolToVisibilityConverter"/>
                                            </Binding.Converter>
                                        </Binding>
                                    </Button.Visibility>
                                </Button>

                                <Button Grid.Column="2"
                                       Content="ðŸ—‘ï¸"
                                       ToolTipService.ToolTip="æ¸…ç©ºæœç´¢åŽ†å²"
                                       Click="ClearSearchHistory_Click"
                                       Padding="8,4"
                                       Margin="4,0,0,0"
                                       VerticalAlignment="Center"/>
                            </Grid>
                            
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock x:Name="RegexErrorTextBlock"
                                           Foreground="#C42B1C"
                                           FontSize="11"
                                           Visibility="Collapsed"/>
                                
                                <TextBlock x:Name="MatchCountTextBlock"
                                           FontSize="11"
                                           Opacity="0.7"
                                           Visibility="Collapsed"/>
                            </StackPanel>
                        </StackPanel>
                        
                        <Button Content="å…¨é€‰"
                                Click="SelectAllLogs_Click"/>
                        
                        <Button Content="ðŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—"
                                Command="{x:Bind ViewModel.ClearLogsCommand}"
                                ToolTipService.ToolTip="æ¸…ç©ºæ‰€æœ‰æ—¥å¿—è®°å½•"/>
                        
                        <CheckBox Content="è‡ªåŠ¨æ»šåŠ¨"
                                  IsChecked="{x:Bind ViewModel.AutoScroll, Mode=TwoWay}"
                                  x:Name="AutoScrollCheckBox"/>
                    </StackPanel>
                </StackPanel>

                <!-- Logs Display - Using ItemsRepeater with Virtualization for High Performance -->
                <ScrollViewer Grid.Row="1"
                              x:Name="LogScrollViewer"
                              VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Auto"
                              Background="{ThemeResource LayerFillColorDefaultBrush}"
                              Padding="8"
                              IsTabStop="True"
                              TabNavigation="Local">
                    <ItemsRepeater x:Name="LogsItemsRepeater"
                                   ItemsSource="{x:Bind ViewModel.DisplayLogs, Mode=OneWay}"
                                   VerticalAlignment="Top">
                        <ItemsRepeater.Layout>
                            <!-- StackLayout with better spacing for readability -->
                            <StackLayout Orientation="Vertical" Spacing="2"/>
                        </ItemsRepeater.Layout>
                        <ItemsRepeater.ItemTemplate>
                            <DataTemplate>
                                <!-- Larger font and better spacing for readability -->
                                <TextBlock Text="{Binding FormattedText}"
                                           Foreground="{Binding ColorHex, Converter={StaticResource HexColorToBrushConverter}}"
                                           FontFamily="Consolas"
                                           FontSize="14"
                                           TextWrapping="NoWrap"
                                           Padding="2,3,2,3"
                                           IsTextSelectionEnabled="True"/>
                            </DataTemplate>
                        </ItemsRepeater.ItemTemplate>
                    </ItemsRepeater>
                </ScrollViewer>

                <!-- Send Area -->
                <StackPanel Grid.Row="2"
                            Spacing="8"
                            Padding="8"
                            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
                    <StackPanel Orientation="Horizontal" Spacing="16">
                        <CheckBox Content="åå…­è¿›åˆ¶å‘é€"
                                  IsChecked="{x:Bind ViewModel.SendAsHex, Mode=TwoWay}"/>
                        <CheckBox Content="æ˜¾ç¤ºå‘é€æ•°æ®"
                                  IsChecked="{x:Bind ViewModel.ShowSentData, Mode=TwoWay}"/>
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <TextBlock Text="TXé¢œè‰²:" VerticalAlignment="Center"/>
                            <ComboBox x:Name="TxColorComboBox"
                                      SelectedValue="{x:Bind ViewModel.TxColorHex, Mode=TwoWay}"
                                      SelectedValuePath="Tag"
                                      Width="100">
                                <ComboBoxItem Tag="#0078D4"><StackPanel Orientation="Horizontal"><Rectangle Width="16" Height="16" Fill="#0078D4" Margin="0,0,8,0"/><TextBlock Text="è“è‰²"/></StackPanel></ComboBoxItem>
                                <ComboBoxItem Tag="#E74856"><StackPanel Orientation="Horizontal"><Rectangle Width="16" Height="16" Fill="#E74856" Margin="0,0,8,0"/><TextBlock Text="çº¢è‰²"/></StackPanel></ComboBoxItem>
                                <ComboBoxItem Tag="#FF8C00"><StackPanel Orientation="Horizontal"><Rectangle Width="16" Height="16" Fill="#FF8C00" Margin="0,0,8,0"/><TextBlock Text="æ©™è‰²"/></StackPanel></ComboBoxItem>
                                <ComboBoxItem Tag="#881798"><StackPanel Orientation="Horizontal"><Rectangle Width="16" Height="16" Fill="#881798" Margin="0,0,8,0"/><TextBlock Text="ç´«è‰²"/></StackPanel></ComboBoxItem>
                            </ComboBox>
                        </StackPanel>
                        <TextBlock Text="(RXé¢œè‰²åœ¨å·²æ‰“å¼€ä¸²å£åˆ—è¡¨ä¸­è®¾ç½®)"
                                   VerticalAlignment="Center"
                                   FontSize="11"
                                   Opacity="0.6"/>
                    </StackPanel>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBox x:Name="SendTextBox"
                                 Grid.Column="0"
                                 Text="{x:Bind ViewModel.SendText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 PlaceholderText="è¾“å…¥è¦å‘é€çš„æ•°æ®..."
                                 Margin="0,0,8,0"/>

                        <Button Grid.Column="1"
                                Content="å‘é€"
                                Style="{StaticResource AccentButtonStyle}"
                                Click="SendButton_Click"/>
                    </Grid>
                </StackPanel>
            </Grid>
        </Grid>

        <!-- Status Bar -->
        <Grid Grid.Row="2"
              Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
              Padding="8,4"
              BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
              BorderThickness="0,1,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            
            <TextBlock Grid.Column="0"
                       Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}"
                       VerticalAlignment="Center"/>
            
            <TextBlock Grid.Column="1"
                       Text="{x:Bind ViewModel.VersionDisplay, Mode=OneWay}"
                       VerticalAlignment="Center"
                       Opacity="0.7"
                       FontSize="11"
                       Margin="16,0,0,0"/>
        </Grid>
    </Grid>
</Window>